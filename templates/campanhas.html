<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campanhas de Doação</title>

    <link
      href="https://cdn.jsdelivr.net/npm/flowbite@2.4.1/dist/flowbite.min.css"
      rel="stylesheet"
    />
    
    <!-- 
      MUDANÇA 1: Caminhos de CSS corrigidos para a pasta 'static' 
    -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/campanhas.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/perfil.css') }}">
</head>
<body>

    <!-- 
      MUDANÇA 2: 'include' do Jinja2 para o header 
    -->
    {% include 'components/header.html' %}

    <main class="main-content">
        <!-- Conteúdo Principal -->
        <div class="campanhas-container">
            <div class="campanhas-layout">
                <!-- Mascote e Informações -->
                <div class="mascote-section">
                    <div class="mascote-card">
                        <figure class="mascote-figure">
                            {# choose gotinha image according to total participations in account #}
                            {% set pc = usuario.participation_count | default(0) %}
                            {% if pc >= 6 %}
                                {% set gotinha_img = 'assets/gotinha1.png' %}
                            {% elif pc >= 4 %}
                                {% set gotinha_img = 'assets/gotinha2.png' %}
                            {% elif pc >= 2 %}
                                {% set gotinha_img = 'assets/gotinha3.png' %}
                            {% else %}
                                {% set gotinha_img = 'assets/gotinha4.png' %}
                            {% endif %}
                            <img class="mascote-image" src="{{ url_for('static', filename=gotinha_img) }}" alt="Hemo - Molécula Guia" onerror="this.src='https://placehold.co/150x150/fecaca/b91c1c?text=Hemo';">
                        </figure>
                    </div>
                </div>

                <!-- Lista de Campanhas -->
                <div class="campanhas-section">
                    <div class="campanhas-header">
                        <h2 class="campanhas-title">Campanhas Ativas</h2>
                        <p class="campanhas-subtitle">Encontre a campanha ideal para sua doação</p>
                    </div>

                    <!-- Tabela de Campanhas -->
                    <div class="campanhas-table-container">
                        <table class="campanhas-table">
                            <thead class="table-header">
                                <tr>
                                    <th scope="col" class="table-head">Nome da Campanha</th>
                                    <th scope="col" class="table-head">Tipo Sanguíneo</th>
                                    <th scope="col" class="table-head">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="campanhasTableBody">
                                <!-- O JS vai preencher esta linha -->
                                <tr class="table-row">
                                    <td colspan="3" class="table-loading">
                                        Carregando campanhas...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Estatísticas -->
                    <div class="estatisticas-grid">
                        {% set conquistas_count = (all_selos | selectattr('unlocked') | list | length) %}
                        <div class="estatistica-card">
                            <div class="estatistica-number" id="totalCampanhas">{{ conquistas_count }}</div>
                            <div class="estatistica-label">Conquistas obtidas</div>
                        </div>
                        <div class="estatistica-card">
                            <div class="estatistica-number" id="totalParticipantes">{{ usuario.participation_count | default(0) }}</div>
                            <div class="estatistica-label">Participações totais</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="profile-card">
                    <h2 class="card-title">Minha Jornada de Doador</h2>
                    
                    <div class="gamification-level">
                        <div class="level-info">
                            <span class="level-title">Nível Atual:</span>
                            <span class="level-name" id="user-level">
                                <svg class="level-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                {{ usuario.nivel | default('Doador Iniciante') }}
                            </span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="user-progress" style="width: {{ usuario.progressoPercentual | default(0) }}%;"></div>
                        </div>
                        <div style="display:flex;align-items:center;gap:1rem;margin-top:0.5rem;">
                            <span class="progress-label">{% if usuario.next_level_name %}Progresso para {{ usuario.next_level_name }}{% else %}Progresso{% endif %}</span>
                            <span class="progress-count" style="font-weight:600;color:#dc2626;">{{ usuario.progress_text }}</span>
                            {% if usuario.participations_to_next is not none and usuario.participations_to_next > 0 %}
                                <span class="progress-remaining" style="color:#6b7280;font-size:0.9rem;">({{ usuario.participations_to_next }} faltam para o próximo nível)</span>
                            {% endif %}
                        </div>
                    </div>
                    
                        <div class="badges-section">
                        <h3 class="badges-title">Conquistas</h3>
                        <div class="badges-container" id="user-badges">
                                {# Render all emblems, marking locked/unlocked based on `all_selos` injected by the app #}
                                {% for selo in all_selos %}
                                {% if not loop.first %}
                                    <div class="badge {% if not selo.unlocked %}badge-locked{% endif %}" title="{{ selo.nome }}">
                                        <img src="{{ url_for('static', filename=selo.caminhoImagem) }}" alt="{{ selo.nome }}" class="badge-image" onerror="this.src='https://placehold.co/64x64/e0e0e0/b0b0b0?text=Selo';">
                                    </div>
                                        {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
</div>
        </div>
    </main>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-container">
            <h3 class="modal-title">Confirmar Participação</h3>
            <p class="modal-message" id="modalMessage">Você tem certeza que deseja participar desta campanha?</p>
            <div class="modal-actions">
                <button onclick="fecharModal()" class="modal-button-cancel">Cancelar</button>
                <button onclick="confirmarParticipacao()" class="modal-button-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- 
      MUDANÇA 4: 'include' do Jinja2 para o footer 
    -->
    {% include 'components/footer.html' %}

    <!-- 
      MUDANÇA 5: Caminhos de JS corrigidos para a pasta 'static' 
    -->
    <script src="{{ url_for('static', filename='scripts/global.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/list_campanhas.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/campanhas.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.4.1/dist/flowbite.min.js"></script>
</body>
</html>